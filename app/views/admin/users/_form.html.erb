<%= form_with(model: [:admin, user], local: true) do |form| %>
  <% if user.errors.any? %>
    <div class="alert alert-danger">
      <h4><%= pluralize(user.errors.count, "error") %> impidieron guardar este usuario:</h4>
      <ul>
        <% user.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="row">
    <div class="col-md-6 mb-3">
      <%= form.label :first_name, "Nombre", class: "form-label" %>
      <%= form.text_field :first_name, class: "form-control" %>
    </div>
    
    <div class="col-md-6 mb-3">
      <%= form.label :last_name, "Apellido", class: "form-label" %>
      <%= form.text_field :last_name, class: "form-control" %>
    </div>
  </div>
  
  <div class="row">
    <div class="col-md-4 mb-3">
      <%= form.label :document, "Documento", class: "form-label" %>
      <%= form.number_field :document, class: "form-control" %>
    </div>
    
    <div class="col-md-4 mb-3">
      <%= form.label :phone, "Teléfono", class: "form-label" %>
      <%= form.text_field :phone, class: "form-control" %>
    </div>
    
    <div class="col-md-4 mb-3">
      <%= form.label :email, "Email", class: "form-label" %>
      <%= form.email_field :email, class: "form-control" %>
    </div>
  </div>
  
  <div class="row">
    <div class="col-md-6 mb-3">
      <%= form.label :password, "Contraseña", class: "form-label" %>
      <%= form.password_field :password, class: "form-control" %>
      <% if user.persisted? %>
        <div class="form-text">Dejar en blanco si no deseas cambiar la contraseña</div>
      <% end %>
    </div>
    
    <div class="col-md-6 mb-3">
      <%= form.label :password_confirmation, "Confirmar Contraseña", class: "form-label" %>
      <%= form.password_field :password_confirmation, class: "form-control" %>
    </div>
  </div>
  
  <!-- Selección de Rol (Admin o Empleado) -->
  <div class="mb-3">
    <label class="form-label">Rol del Usuario</label>
    <div class="row">
      <% @roles.each do |role| %>
        <div class="col-md-4 mb-2">
          <div class="form-check">
            <%= radio_button_tag 'user[role_ids][]', role.id, user.roles.include?(role), id: "role_#{role.id}", class: "form-check-input" %>
            <%= label_tag "role_#{role.id}", role.name.capitalize, class: "form-check-label" %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
  
  <!-- Permisos a Módulos/Componentes -->
  <div class="mb-3">
    <label class="form-label">Permisos a Módulos</label>
    <div class="row">
      <% @permissions.each do |permission| %>
        <div class="col-md-4 mb-2">
          <div class="form-check">
            <% has_permission = user.permissions.include?(permission) %>
            <%= check_box_tag 'user[permission_ids][]', permission.id, has_permission, id: "permission_#{permission.id}", class: "form-check-input" %>
            <%= label_tag "permission_#{permission.id}", permission.name_module.humanize, class: "form-check-label" %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
  
  <div class="mt-4">
    <%= form.submit user.new_record? ? "Crear Usuario" : "Actualizar Usuario", class: "btn btn-primary" %>
  </div>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Agregar nuevo permiso
    document.getElementById('add-permission').addEventListener('click', function() {
      const container = document.getElementById('permissions-container');
      const newRow = document.querySelector('.permission-row').cloneNode(true);
      
      // Limpiar los valores seleccionados
      newRow.querySelectorAll('select').forEach(select => {
        select.selectedIndex = 0;
      });
      
      // Agregar evento para eliminar
      newRow.querySelector('.remove-permission').addEventListener('click', function() {
        if (document.querySelectorAll('.permission-row').length > 1) {
          this.closest('.permission-row').remove();
        }
      });
      
      container.appendChild(newRow);
    });
    
    // Eliminar permiso
    document.querySelectorAll('.remove-permission').forEach(button => {
      button.addEventListener('click', function() {
        if (document.querySelectorAll('.permission-row').length > 1) {
          this.closest('.permission-row').remove();
        }
      });
    });
  });
</script>